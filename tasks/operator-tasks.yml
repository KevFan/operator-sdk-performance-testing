---
- name: Set the {{ operator_type }} memcached operator image name.
  set_fact:
    operator_image: "{{ registry }}/{{ image_name }}-{{ operator_type }}:{{ image_tag }}"

- name: Build, push, and deploy the {{ operator_type }} memcached operator.
  shell: "{{ item }}"
  args:
    chdir: ./operator-sdk-samples/{{ operator_type }}/memcached-operator
  with_items:
    # Can't use make for docker-build target because of Go operator test dep.
    - docker build . -t $IMG
    - make docker-push
    - make install
    - make deploy
  environment:
    IMG: "{{ operator_image }}"
    executable: /bin/bash

- name: Wait for Operator Pod to be 'Running'.
  k8s_info:
    api_version: v1
    kind: Pod
    label_selectors:
      - control-plane=controller-manager
    namespace: memcached-operator-system
  register: pod
  until: pod.resources[0].status.phase == 'Running'
  delay: 3
  retries: 10

# - name: Pause so I can do some testing, poking, and prodding.
#   pause:
#     minutes: 30

# TODO: Create 50 CRs, wait for reconciliation to finish, and see how long it
# took.

# TODO: Kill Operator Pod, wait for it to start again, see how long it takes for
# it to finish reconciling again.

- name: Undeploy the {{ operator_type }} memcached operator.
  command: make undeploy
  args:
    chdir: ./operator-sdk-samples/{{ operator_type }}/memcached-operator
  environment:
    IMG: "{{ operator_image }}"
