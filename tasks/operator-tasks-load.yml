---
- name: Set the {{ operator_type }} memcached operator image name.
  set_fact:
    operator_image: "{{ registry }}/{{ image_name }}-{{ operator_type }}:{{ image_tag }}"

- name: Set the app label selector for Helm.
  set_fact:
    app_label_selector: app.kubernetes.io/name=memcached
  when: operator_type == 'helm'

- name: Ensure the operator namespace exists.
  k8s:
    name: memcached-operator-system
    api_version: v1
    kind: Namespace
    state: present

- name: Set the correct subdirectory for the Go operator example.
  set_fact:
    operator_subdir: v2/memcached-operator
  when: operator_type == 'go'

- name: Build, push, and deploy the {{ operator_type }} memcached operator.
  shell: "{{ item }}"
  args:
    chdir: ./operator-sdk/testdata/{{ operator_type }}/{{ operator_subdir }}
  with_items:
    # Can't use make for docker-build target because of Go operator test dep.
    - docker build . -t $IMG
    - make docker-push
    - make install
    - make deploy
  environment:
    IMG: "{{ operator_image }}"
    executable: /bin/bash

- name: Wait for Operator Pod to be 'Running'.
  k8s_info:
    api_version: v1
    kind: Pod
    label_selectors:
      - control-plane=controller-manager
    namespace: memcached-operator-system
  register: operator_pod
  failed_when: false
  until: operator_pod.resources[0].status.phase == 'Running'
  delay: 3
  retries: 15

- name: Pause to allow cluster to stabilize.
  pause:
    seconds: 10

- name: Perform load 
  include_tasks: load.yml
  with_sequence: count=3

